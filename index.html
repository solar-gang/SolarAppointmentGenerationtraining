<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>LOS ‚Ä¢ Rep Training Hub</title>
  <meta name="theme-color" content="#0b1017"/>

  <!--
    Put these files in repo root (same folder as index.html):

    Logo.png

    Yucaipa.pdf
    Yucaipa2.(jpg/png/pdf)
    Yucaipa3.(jpg/png/pdf)

    Add-on-bill.pdf
    Add-on-bill2.(jpg/png/pdf)
    Add-on-bill3.(jpg/png/pdf)

    Laminate-1-2.pdf

    Scebill.jpeg (or .jpg / .png / .pdf)

    Recommended: add an empty file named ".nojekyll" in repo root.
  -->

  <style>
    :root{
      --bg:#0b1017;
      --panel:#0f1826;
      --panel2:#0c1522;
      --ink:rgba(255,255,255,.96);
      --muted:rgba(255,255,255,.70);
      --line:rgba(255,255,255,.10);

      --gold:#FBC909;
      --teal:#3AADBB;

      --shadow: 0 18px 70px rgba(0,0,0,.45);
      --r:16px;
      --r2:22px;

      --safeT: env(safe-area-inset-top);
      --safeB: env(safe-area-inset-bottom);
      --safeL: env(safe-area-inset-left);
      --safeR: env(safe-area-inset-right);
    }

    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;background:var(--bg);color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif
    }

    .container{
      max-width:1220px;margin:0 auto;
      padding:16px;
      padding-left:calc(16px + var(--safeL));
      padding-right:calc(16px + var(--safeR));
      padding-bottom:calc(16px + var(--safeB));
    }

    /* Topbar */
    .topbar{
      position:sticky;top:0;z-index:50;
      background:rgba(11,16,23,.82);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--line);
      padding:12px 14px;
      padding-top:calc(12px + var(--safeT));
      display:flex;gap:12px;align-items:center;justify-content:space-between;
    }
    .brand{display:flex;gap:10px;align-items:center;min-width:240px}
    .logo{
      width:44px;height:44px;object-fit:contain;border-radius:12px;
      border:1px solid var(--line);background:rgba(255,255,255,.04)
    }
    .brandTitle{font-weight:950;letter-spacing:.2px}
    .brandSub{font-size:12px;color:var(--muted);margin-top:2px}

    .nav{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    .nav a{
      text-decoration:none;font-size:14px;color:var(--muted);
      padding:9px 12px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);white-space:nowrap;
      transition:transform .12s ease,border-color .12s ease,color .12s ease, background .12s ease;
    }
    .nav a:hover{border-color:rgba(255,255,255,.18);color:var(--ink);transform:translateY(-1px);background:rgba(255,255,255,.05)}
    .nav a.active{
      color:var(--ink);
      border-color:rgba(58,173,187,.55);
      box-shadow:0 10px 24px rgba(58,173,187,.12);
      background:rgba(58,173,187,.08);
    }

    /* Hero */
    .hero{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:var(--r2);
      box-shadow:var(--shadow);
      padding:16px;
      background:
        radial-gradient(1100px 520px at 12% 0%, rgba(251,201,9,.18), transparent 55%),
        radial-gradient(900px 520px at 88% 10%, rgba(58,173,187,.16), transparent 55%),
        linear-gradient(135deg, rgba(251,201,9,.08), rgba(58,173,187,.06));
    }
    .hero h1{margin:0 0 8px;font-size:24px}
    .hero p{margin:0;color:var(--muted);line-height:1.45}
    .pillRow{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
    .pill{
      font-size:12px;padding:7px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:var(--muted)
    }

    /* Cards */
    .grid{margin-top:12px;display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{
      grid-column:span 12;
      border:1px solid var(--line);
      border-radius:var(--r2);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      padding:14px;
    }
    .cardHeader{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .cardTitle{font-weight:950;margin:0;font-size:18px}
    .tag{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      border-radius:999px;padding:7px 10px;background:rgba(255,255,255,.03);white-space:nowrap;
    }
    .cardText{color:var(--muted);line-height:1.45;margin-top:8px}
    .divider{height:1px;background:var(--line);margin:12px 0}

    /* Viewer */
    .viewerWrap{display:grid;gap:12px}
    .viewerHeader{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
    .selectRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    select{
      appearance:none;border:1px solid var(--line);
      border-radius:12px;padding:10px 12px;font-size:14px;
      background:rgba(255,255,255,.03);color:var(--ink);
      box-shadow:0 8px 18px rgba(0,0,0,.25);
    }
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--ink);
      padding:10px 12px;border-radius:12px;font-weight:900;
      cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.25);
      transition:transform .12s ease, border-color .12s ease, background .12s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.05)}
    .btnPrimary{background:linear-gradient(135deg,var(--gold),var(--teal));border-color:transparent;color:#06122a}
    .btnSmall{padding:8px 10px;border-radius:10px;font-weight:900}

    .pagePill{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      border-radius:999px;padding:7px 10px;background:rgba(255,255,255,.03);white-space:nowrap;
    }

    .viewerShell{
      border:1px solid var(--line);
      border-radius:var(--r2);
      overflow:hidden;
      background:#000;
      box-shadow:var(--shadow);
      height:62vh;min-height:420px;
      position:relative;
    }

    /* PDF iframe */
    .viewerShell iframe{
      width:100%;height:100%;
      border:0;
      background:#000;
      display:none;
    }

    /* Image stage (for snapshots) */
    .imgStage{
      position:absolute;inset:0;
      overflow:hidden;
      background:#000;
      display:none;
    }
    .imgCanvas{
      position:absolute;left:50%;top:50%;
      transform:translate(-50%,-50%) scale(1);
      transform-origin:center center;
      will-change:transform;
    }
    .imgCanvas img{
      display:block;
      max-width:none;
      width:auto;height:auto;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
    }

    /* Callout overlay */
    .calloutLayer{
      position:absolute;inset:0;
      pointer-events:none;
      z-index:5;
    }
    .calloutDot{
      position:absolute;
      width:22px;height:22px;border-radius:50%;
      background:linear-gradient(135deg,var(--gold),var(--teal));
      box-shadow:0 0 0 6px rgba(251,201,9,.22);
      cursor:pointer;
      pointer-events:auto;
    }
    .calloutDot::after{
      content:"+";
      position:absolute;inset:0;
      display:flex;align-items:center;justify-content:center;
      font-weight:950;color:#06122a;
    }

    /* Popup */
    .popup{
      position:fixed;
      left:16px;right:16px;bottom:16px;
      background:rgba(15,24,38,.96);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow:0 20px 60px rgba(0,0,0,.6);
      z-index:9999;
      backdrop-filter: blur(10px);
    }
    .popup h4{margin:0 0 6px;font-size:16px}
    .popup p{margin:0;color:var(--muted);line-height:1.4}
    .popup .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .popup .row .btn{width:100%}

    .side{
      border:1px solid var(--line);
      border-radius:var(--r2);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      padding:14px;
    }
    .side h3{margin:0 0 6px;font-size:16px}
    .side p{margin:0;color:var(--muted);line-height:1.45}
    .list{margin:10px 0 0 0;padding:0;list-style:none;display:grid;gap:10px}
    .item{
      border:1px solid var(--line);
      border-radius:14px;padding:12px;
      background:
        radial-gradient(600px 220px at 0% 0%, rgba(251,201,9,.10), transparent 55%),
        radial-gradient(600px 220px at 100% 0%, rgba(58,173,187,.08), transparent 55%),
        rgba(255,255,255,.02);
    }
    .item b{color:var(--ink)}
    .item small{display:block;color:var(--muted);margin-top:6px;line-height:1.35}

    details.training{border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.02);overflow:hidden}
    details.training + details.training{margin-top:10px}
    details.training summary{
      list-style:none;cursor:pointer;padding:12px 12px;
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
      user-select:none;font-weight:950;color:var(--ink);
    }
    details.training summary::-webkit-details-marker{display:none}
    .left{display:flex;gap:10px;align-items:flex-start}
    .dot{width:10px;height:10px;border-radius:999px;margin-top:5px;background:linear-gradient(135deg,var(--gold),var(--teal))}
    .caret{
      width:10px;height:10px;border-right:2px solid rgba(255,255,255,.45);border-bottom:2px solid rgba(255,255,255,.45);
      transform:rotate(45deg);margin-top:6px;transition:transform .12s ease;flex:0 0 auto;
    }
    details[open] .caret{transform:rotate(225deg);margin-top:10px}
    .body{padding:0 12px 12px 12px;color:var(--muted);line-height:1.45}
    .body ul{margin:8px 0 0 18px}
    .body li{margin:7px 0}

    /* $/kWh calculator */
    .calcGrid{display:grid;gap:10px;margin-top:10px}
    .calcRow{display:grid;gap:10px}
    .field{
      border:1px solid var(--line);
      border-radius:14px;padding:12px;background:rgba(255,255,255,.03);
      box-shadow:0 8px 18px rgba(0,0,0,.25);
    }
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:900}
    .field input{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;padding:12px 12px;font-size:16px;outline:none;
      color:var(--ink);background:rgba(255,255,255,.02);
    }
    .result{border:1px solid rgba(155,230,58,.35);background:rgba(155,230,58,.10);border-radius:14px;padding:12px;font-weight:950}
    .result .big{font-size:22px}
    .mini{font-size:12px;color:var(--muted);font-weight:800;margin-top:6px;line-height:1.35}

    .footer{margin:16px 0 10px;color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}

    @media (min-width: 980px){
      .hero h1{font-size:30px}
      .viewerWrap{grid-template-columns: 7fr 5fr;align-items:start}
      .viewerShell{height:70vh;min-height:520px}
      .calcRow{grid-template-columns:1fr 1fr}
      .popup{left:auto;right:20px;bottom:20px;max-width:420px}
      .popup .row .btn{width:auto}
    }
  </style>
</head>

<body>
<header class="topbar">
  <div class="brand">
    <img src="Logo.png" class="logo" alt="Leverage Our Sun"/>
    <div>
      <div class="brandTitle">LOS Rep Training Hub</div>
      <div class="brandSub">Win the day ‚Ä¢ Own the night</div>
    </div>
  </div>

  <nav class="nav" id="nav">
    <a href="#bill" class="active">Bill Knowledge</a>
    <a href="#approach">Door Approach</a>
    <a href="#growth">Self Growth</a>
    <a href="#kwh">$/kWh</a>
  </nav>
</header>

<main class="container">
  <section class="hero">
    <h1>Make bills simple (and fun).</h1>
    <p>
      Choose a bill type, hit the callout dots, and learn the story: <b>how much</b> (kWh) + <b>when</b> (TOU) + <b>why</b> (delivery vs generation / imports vs credits).
    </p>
    <div class="pillRow">
      <span class="pill">Tap dots to zoom</span>
      <span class="pill">Callouts auto-change by page</span>
      <span class="pill">Mobile + desktop</span>
    </div>
  </section>

  <section class="grid">
    <section class="card" id="bill">
      <div class="cardHeader">
        <h2 class="cardTitle">Bill Knowledge / Problem</h2>
        <span class="tag">Teach ‚Üí Transition ‚Üí Book</span>
      </div>
      <p class="cardText">
        Page 1 uses the original PDF. Pages 2‚Äì3 use your snapshot files (Yucaipa2/3, Add-on-bill2/3). Click callout dots to zoom and get a short explanation.
      </p>

      <div class="divider"></div>

      <div class="viewerWrap">
        <!-- LEFT -->
        <div>
          <div class="viewerHeader">
            <div class="selectRow">
              <select id="billSelect" aria-label="Choose bill">
                <option value="tou">TOU ‚Äì Domestic</option>
                <option value="nem2">NEM 2.0 (Solar)</option>
                <option value="nem3">NEM 3.0 (Solar)</option>
                <option value="dcare">DCARE ‚Äì Tiers (no solar)</option>
              </select>
              <span class="pagePill" id="pageLabel">Page 1 / 3</span>
            </div>

            <div class="controls">
              <button class="btn btnSmall" id="openNew">Open</button>
              <button class="btn btnSmall" id="prevBtn">Prev</button>
              <button class="btn btnSmall btnPrimary" id="nextBtn">Next</button>
            </div>
          </div>

          <div class="divider"></div>

          <div class="viewerShell" id="viewerShell">
            <iframe id="pdfFrame" title="PDF Viewer"></iframe>

            <div class="imgStage" id="imgStage">
              <div class="imgCanvas" id="imgCanvas">
                <img id="imgEl" alt="Snapshot"/>
              </div>
            </div>

            <div class="calloutLayer" id="calloutLayer"></div>
          </div>
        </div>

        <!-- RIGHT -->
        <aside class="side">
          <h3>What to say (fast)</h3>
          <p id="coachText">Pick a callout dot. Teach one idea, then book the consult.</p>

          <ul class="list" id="quickList" style="margin-top:12px">
            <li class="item">
              <b>Non-solar homes</b>
              <small>Explain delivery vs generation + TOU. Then: ‚ÄúLet‚Äôs verify day-one savings.‚Äù</small>
            </li>
            <li class="item">
              <b>Solar homes still paying</b>
              <small>Explain imports vs credits + TOU. Then: ‚ÄúBattery = controlled peak buying.‚Äù</small>
            </li>
          </ul>

          <div class="divider"></div>

          <h3>60-second close</h3>
          <div class="item">
            <b>‚ÄúIf it doesn‚Äôt save day one, we stop.‚Äù</b>
            <small>‚ÄúWould you prefer <b>today</b> or <b>tomorrow</b> for a quick 30‚Äì45 min consult?‚Äù</small>
          </div>
        </aside>
      </div>
    </section>

    <section class="card" id="approach">
      <div class="cardHeader">
        <h2 class="cardTitle">Door Approach</h2>
        <span class="tag">Structure wins</span>
      </div>

      <details class="training" open>
        <summary>
          <span class="left"><span class="dot"></span>Structure: Intro ‚Üí Problem ‚Üí Solution ‚Üí Takeaways ‚Üí Transition ‚Üí Assume sale</span>
          <span class="caret"></span>
        </summary>
        <div class="body">
          <ul>
            <li><b>Intro:</b> ‚ÄúHi, I‚Äôm Carlos‚Äîmy team‚Äôs doing the power projects out here.‚Äù</li>
            <li><b>Problem:</b> ‚ÄúPrices vary by time of day and rates keep rising.‚Äù</li>
            <li><b>Solution:</b> ‚ÄúSolar handles the ‚Äòhow much.‚Äô Batteries handle the ‚Äòwhen.‚Äô‚Äù</li>
            <li><b>Takeaways:</b> ‚ÄúWe only move forward if it saves day one.‚Äù</li>
            <li><b>Transition:</b> ‚ÄúLet‚Äôs verify using your usage + bill.‚Äù</li>
            <li><b>Assume sale:</b> ‚ÄúToday at 6:30 or tomorrow at 4?‚Äù</li>
          </ul>
        </div>
      </details>

      <details class="training">
        <summary>
          <span class="left"><span class="dot"></span>Tone + pace (confidence)</span>
          <span class="caret"></span>
        </summary>
        <div class="body">
          <ul>
            <li>Slow down 10‚Äì15%. Short sentences.</li>
            <li>Down-tone for certainty. Up-tone only for questions.</li>
            <li>Pause after questions. Let them answer.</li>
          </ul>
        </div>
      </details>

      <details class="training">
        <summary>
          <span class="left"><span class="dot"></span>Body language</span>
          <span class="caret"></span>
        </summary>
        <div class="body">
          <ul>
            <li>Hands visible, calm gestures.</li>
            <li>Stand at an angle; give space.</li>
            <li>Eye contact when asking; soft eyes when listening.</li>
          </ul>
        </div>
      </details>
    </section>

    <section class="card" id="growth">
      <div class="cardHeader">
        <h2 class="cardTitle">Self Growth</h2>
        <span class="tag">Routine wins</span>
      </div>

      <details class="training" open>
        <summary>
          <span class="left"><span class="dot"></span>Daily (15 minutes)</span>
          <span class="caret"></span>
        </summary>
        <div class="body">
          <ul>
            <li>5 min: repeat the 60-sec close out loud.</li>
            <li>5 min: explain one bill callout in plain English.</li>
            <li>5 min: plan your best streets for tomorrow.</li>
          </ul>
        </div>
      </details>

      <details class="training">
        <summary>
          <span class="left"><span class="dot"></span>Weekly (level up)</span>
          <span class="caret"></span>
        </summary>
        <div class="body">
          <ul>
            <li>Record yourself once/week (intro + close).</li>
            <li>Role-play objections (10 minutes).</li>
            <li>Review your best conversations and copy what worked.</li>
          </ul>
        </div>
      </details>
    </section>

    <section class="card" id="kwh">
      <div class="cardHeader">
        <h2 class="cardTitle">$/kWh Quick Calculator</h2>
        <span class="tag">Teach it fast</span>
      </div>
      <p class="cardText">Explain in one line: ‚ÄúYou‚Äôre paying about <b>$X per kWh</b> right now.‚Äù</p>

      <div class="calcGrid">
        <div class="calcRow">
          <div class="field">
            <label>Monthly bill amount ($)</label>
            <input id="billAmount" inputmode="decimal" placeholder="Example: 333.92"/>
          </div>
          <div class="field">
            <label>Monthly usage (kWh)</label>
            <input id="kwhUsage" inputmode="decimal" placeholder="Example: 1258"/>
          </div>
        </div>

        <button class="btn btnPrimary" id="calcBtn" style="width:100%">Calculate $/kWh</button>

        <div class="result" id="calcOut">
          <div class="big">Enter bill + kWh</div>
          <div class="mini">Tip: use the ‚ÄúTotal usage (kWh)‚Äù line from the bill.</div>
        </div>
      </div>
    </section>
  </section>

  <div class="footer">
    <div>¬© Leverage Our Sun ‚Ä¢ Training Hub</div>
    <div>Tip: add <b>.nojekyll</b> to repo root for GitHub Pages stability.</div>
  </div>
</main>

<script>
/* -----------------------------
   FILE RESOLUTION HELPERS
----------------------------- */
const EXT_ORDER = ["pdf","jpg","jpeg","png","webp"];

async function urlExists(url){
  try{
    const r = await fetch(url, { method:"HEAD", cache:"no-store" });
    if(r.ok) return true;
  }catch(e){}
  try{
    const r2 = await fetch(url, { method:"GET", cache:"no-store" });
    return r2.ok;
  }catch(e){}
  return false;
}

async function resolveFirstExisting(baseName){
  // baseName should include extension if already known
  if(baseName.includes(".")){
    const ok = await urlExists(baseName);
    return ok ? baseName : null;
  }
  for(const ext of EXT_ORDER){
    const candidate = `${baseName}.${ext}`;
    const ok = await urlExists(candidate);
    if(ok) return candidate;
  }
  return null;
}

/* -----------------------------
   BILL DEFINITIONS
----------------------------- */
const BILLS = {
  tou: {
    label: "TOU ‚Äì Domestic",
    pages: [
      { type:"pdf", src:"Yucaipa.pdf", page:1 },        // page 1 (PDF)
      { type:"snap", base:"Yucaipa2" },                 // page 2 (snapshot)
      { type:"snap", base:"Yucaipa3" }                  // page 3 (snapshot)
    ]
  },
  nem2: {
    label: "NEM 2.0 (Solar)",
    pages: [
      { type:"pdf", src:"Add-on-bill.pdf", page:1 },    // page 1 (PDF)
      { type:"snap", base:"Add-on-bill2" },             // page 2 (snapshot)
      { type:"snap", base:"Add-on-bill3" }              // page 3 (snapshot)
    ]
  },
  nem3: {
    label: "NEM 3.0 (Solar)",
    pages: [
      { type:"pdf", src:"Laminate-1-2.pdf", page:1 }    // simple PDF (page 1)
    ]
  },
  dcare: {
    label: "DCARE ‚Äì Tiers (no solar)",
    pages: [
      { type:"snap", base:"Scebill" }                   // single screenshot
    ]
  }
};

/* -----------------------------
   CALLOUTS
   - coords are percentages (0‚Äì100)
   - z is zoom level for images (scale)
----------------------------- */
const CALLOUTS = {
  // Page indexing here is 1-based within our training pages
  tou: {
    1: [
      { x:72, y:32, z:1.8, t:"TOU breakdown", d:"This is the ‚ÄúWHEN.‚Äù Peak hours cost more. Batteries are how we avoid buying expensive peak power." },
      { x:24, y:58, z:1.6, t:"Bar graph (kWh)", d:"Each bar is usage. Taller bar = more kWh. This tells system size‚Äînot price." },
      { x:22, y:78, z:1.9, t:"Delivery vs Generation", d:"Two buckets: delivery (grid costs) + generation (energy). Solar mainly offsets generation." }
    ],
    2: [
      // Yucaipa2 (TOU table + usage)
      { x:30, y:20, z:2.2, t:"TOU schedule", d:"Teach the windows: off-peak is cheapest, peak is most expensive. The ‚Äòwhen‚Äô is what changed." },
      { x:20, y:44, z:2.2, t:"Usage by TOU", d:"These lines show how much kWh happened in each time period. Big peak usage = higher bill." },
      { x:28, y:63, z:1.9, t:"Daily average graph", d:"Shows trend month-to-month. If it‚Äôs climbing, rate hikes hurt more." },
      { x:22, y:86, z:2.0, t:"Charges start here", d:"This is where the bill explains what you‚Äôre paying for. Keep it simple: delivery vs generation." }
    ],
    3: [
      // Yucaipa3 (tracked charges)
      { x:20, y:24, z:2.2, t:"Delivery charges by TOU", d:"Even before solar, delivery is big. Batteries help reduce peak buying but delivery still exists." },
      { x:20, y:54, z:2.2, t:"Generation charges by TOU", d:"This is the energy cost. Solar offsets this part the most." },
      { x:74, y:30, z:2.0, t:"Extra info box", d:"This explains net consumption/generation totals and year-to-date. Great for trust." }
    ]
  },

  nem2: {
    1: [
      { x:22, y:30, z:1.8, t:"Solar credits vs charges", d:"Solar exports earn credits. Imports (night/peak) cost money. The mix determines your bill." },
      { x:70, y:62, z:1.6, t:"Usage / TOU still matters", d:"Even with solar, peak buying can crush savings. Battery = controlled peak buying." }
    ],
    2: [
      // Add-on-bill2 (net consumption/generation + delivery charges + graph)
      { x:28, y:46, z:2.1, t:"Net consumption vs net generation", d:"Consumption = energy imported. Net generation = excess exported. Solar customers need both explained." },
      { x:24, y:64, z:1.9, t:"Bar graph", d:"If bars stay high in the evening, solar alone won‚Äôt cover it. That‚Äôs the battery story." },
      { x:22, y:86, z:2.0, t:"Delivery + NBCs", d:"Non-bypassable charges & delivery costs still apply. Set expectation: solar doesn‚Äôt erase grid fees." }
    ],
    3: [
      // Add-on-bill3 (tracked charges delivery vs generation by TOU)
      { x:22, y:26, z:2.2, t:"Delivery charges (solar)", d:"Grid costs still show up. Teach: ‚ÄòWe can‚Äôt delete delivery‚Äîwhat we do is reduce expensive peak energy.‚Äô" },
      { x:22, y:52, z:2.2, t:"Generation charges (solar)", d:"This is what you‚Äôre buying from SCE. Battery + solar reduces how much you buy at peak." },
      { x:74, y:26, z:2.0, t:"YTD box", d:"Great credibility: ‚ÄòHere‚Äôs your year-to-date energy and totals.‚Äô" }
    ]
  },

  dcare: {
    1: [
      { x:22, y:26, z:2.0, t:"Usage bar graph", d:"These bars show monthly usage trend. Higher usage = higher tier exposure." },
      { x:20, y:52, z:2.2, t:"Delivery charges", d:"Delivery is the grid cost bucket. It rises over time and is tied to tiers/baseline too." },
      { x:20, y:66, z:2.2, t:"Generation charges", d:"This is the energy you‚Äôre buying. Solar offsets this portion." },
      { x:62, y:90, z:2.0, t:"Tier 1 vs Tier 2 $/kWh", d:"Tier 2 is more expensive. The goal is to avoid high-priced kWh using solar (and batteries for peak)." }
    ]
  }
};

/* -----------------------------
   VIEWER STATE
----------------------------- */
const billSelect = document.getElementById("billSelect");
const pageLabel  = document.getElementById("pageLabel");
const prevBtn    = document.getElementById("prevBtn");
const nextBtn    = document.getElementById("nextBtn");
const openNew    = document.getElementById("openNew");

const pdfFrame   = document.getElementById("pdfFrame");
const imgStage   = document.getElementById("imgStage");
const imgCanvas  = document.getElementById("imgCanvas");
const imgEl      = document.getElementById("imgEl");
const calloutLayer = document.getElementById("calloutLayer");

let currentBillKey = "tou";
let currentPageIndex = 1; // 1-based in our training pages
let popupEl = null;

// image zoom state
let imgScale = 1;
let imgTx = 0;
let imgTy = 0;

// For Safari/iOS PDF reload
let lastPdfSrc = "";

/* -----------------------------
   POPUP
----------------------------- */
function closePopup(){
  if(popupEl){ popupEl.remove(); popupEl = null; }
}
function showPopup(title, desc){
  closePopup();
  const div = document.createElement("div");
  div.className = "popup";
  div.innerHTML = `
    <h4>${title}</h4>
    <p>${desc}</p>
    <div class="row">
      <button class="btn btnPrimary" id="popOk">Got it</button>
      <button class="btn" id="popClose">Close</button>
    </div>
  `;
  document.body.appendChild(div);
  popupEl = div;
  div.querySelector("#popOk").onclick = closePopup;
  div.querySelector("#popClose").onclick = closePopup;
}

/* -----------------------------
   IMAGE PAN/ZOOM
----------------------------- */
function applyImgTransform(){
  imgCanvas.style.transform =
    `translate(calc(-50% + ${imgTx}px), calc(-50% + ${imgTy}px)) scale(${imgScale})`;
}
function focusImageOnPercent(x, y, zoom){
  // x,y are % of the container
  const rect = imgStage.getBoundingClientRect();
  const cx = rect.width * (x/100);
  const cy = rect.height * (y/100);
  const targetScale = zoom || 2.0;

  // Move target point toward center
  const centerX = rect.width/2;
  const centerY = rect.height/2;

  imgScale = targetScale;
  imgTx = (centerX - cx) / 1; // translation in px
  imgTy = (centerY - cy) / 1;

  applyImgTransform();
}

/* -----------------------------
   RENDER CALLOUTS
----------------------------- */
function clearCallouts(){ calloutLayer.innerHTML = ""; }

function renderCallouts(){
  clearCallouts();

  const perBill = CALLOUTS[currentBillKey] || {};
  const list = perBill[currentPageIndex] || [];

  if(!list.length) return;

  list.forEach((c) => {
    const dot = document.createElement("div");
    dot.className = "calloutDot";
    dot.style.left = `calc(${c.x}% - 11px)`;
    dot.style.top  = `calc(${c.y}% - 11px)`;

    dot.onclick = () => {
      // If image snapshot, zoom using our image stage
      if(imgStage.style.display === "block"){
        focusImageOnPercent(c.x, c.y, c.z || 2.0);
      }else{
        // If PDF, just zoom in the PDF viewer (browser-dependent but helpful)
        const bill = BILLS[currentBillKey];
        const pageObj = bill.pages[currentPageIndex-1];
        const pdf = pageObj?.src || bill.pages[0].src;
        const z = Math.round((c.z || 1.6) * 100);
        const src = `${pdf}#page=1&zoom=${z}&t=${Date.now()}`;
        forceSetPdf(src);
      }
      showPopup(c.t, c.d);
    };

    calloutLayer.appendChild(dot);
  });
}

/* -----------------------------
   PDF LOADING (iOS safe)
----------------------------- */
function forceSetPdf(src){
  if(src === lastPdfSrc) return;
  lastPdfSrc = src;
  pdfFrame.src = "about:blank";
  setTimeout(()=>{ pdfFrame.src = src; }, 35);
}

/* -----------------------------
   PAGE LOADING
----------------------------- */
async function loadCurrent(){
  closePopup();
  const bill = BILLS[currentBillKey];
  const totalPages = bill.pages.length;
  currentPageIndex = Math.max(1, Math.min(totalPages, currentPageIndex));
  pageLabel.textContent = `Page ${currentPageIndex} / ${totalPages}`;

  const pageObj = bill.pages[currentPageIndex-1];

  // Default: hide both, show based on type
  pdfFrame.style.display = "none";
  imgStage.style.display = "none";
  imgEl.src = "";
  imgScale = 1; imgTx = 0; imgTy = 0;
  applyImgTransform();

  if(pageObj.type === "pdf"){
    const pdfSrc = `${pageObj.src}#page=${pageObj.page || 1}&zoom=page-width&t=${Date.now()}`;
    pdfFrame.style.display = "block";
    forceSetPdf(pdfSrc);

    openNew.onclick = () => window.open(pdfSrc, "_blank", "noopener");
  }else{
    // Snapshot: resolve extension
    const resolved = await resolveFirstExisting(pageObj.base);
    if(!resolved){
      // If snapshot missing, show a helpful placeholder using PDF instead
      imgStage.style.display = "block";
      imgEl.src = "";
      showPopup("Missing snapshot file",
        `I couldn‚Äôt find "${pageObj.base}.(pdf/jpg/png)". Upload it to the same folder as index.html and refresh.`);
      openNew.onclick = () => {};
    }else{
      imgStage.style.display = "block";
      imgEl.src = resolved;
      openNew.onclick = () => window.open(resolved, "_blank", "noopener");
    }
  }

  // Render callouts for this page
  renderCallouts();
}

/* -----------------------------
   NAV
----------------------------- */
billSelect.addEventListener("change", ()=>{
  currentBillKey = billSelect.value;
  currentPageIndex = 1;
  lastPdfSrc = "";
  loadCurrent();
});
prevBtn.addEventListener("click", ()=>{
  currentPageIndex -= 1;
  loadCurrent();
});
nextBtn.addEventListener("click", ()=>{
  currentPageIndex += 1;
  loadCurrent();
});

// highlight nav on scroll
const links = Array.from(document.querySelectorAll("#nav a"));
const sections = ["bill","approach","growth","kwh"].map(id => document.getElementById(id));
const setActive = (hash)=> links.forEach(a => a.classList.toggle("active", a.getAttribute("href")===hash));
const obs = new IntersectionObserver((entries)=>{
  const v = entries.filter(e=>e.isIntersecting).sort((a,b)=>b.intersectionRatio-a.intersectionRatio)[0];
  if(!v) return;
  setActive("#"+v.target.id);
}, { rootMargin: "-45% 0px -50% 0px", threshold:[0.1,0.2,0.3,0.4,0.5] });
sections.forEach(s => s && obs.observe(s));

/* -----------------------------
   $/kWh calculator
----------------------------- */
const billAmount = document.getElementById("billAmount");
const kwhUsage   = document.getElementById("kwhUsage");
const calcBtn    = document.getElementById("calcBtn");
const calcOut    = document.getElementById("calcOut");

calcBtn.addEventListener("click", ()=>{
  const b = parseFloat((billAmount.value||"").replace(/[^0-9.]/g,""));
  const k = parseFloat((kwhUsage.value||"").replace(/[^0-9.]/g,""));
  if(!isFinite(b)||!isFinite(k)||b<=0||k<=0){
    calcOut.innerHTML = `<div class="big">Enter valid numbers</div><div class="mini">Example: $333.92 and 1258 kWh</div>`;
    return;
  }
  const p = b/k;
  const nice = p.toFixed(2);
  let vibe = "‚úÖ Solid.";
  if(p >= 0.40) vibe = "üî• High. Peak hours are crushing them.";
  else if(p >= 0.30) vibe = "‚ö° Elevated. TOU + delivery charges add up.";
  calcOut.innerHTML =
    `<div class="big">$${nice} <span style="font-weight:950">per kWh</span></div>
     <div class="mini">${vibe} Say: ‚ÄúYou‚Äôre paying about <b>$${nice}</b> for every kWh you use.‚Äù</div>`;
});

/* -----------------------------
   INIT
----------------------------- */
billSelect.value = "tou";
currentBillKey = "tou";
currentPageIndex = 1;
loadCurrent();
</script>
</body>
</html>
