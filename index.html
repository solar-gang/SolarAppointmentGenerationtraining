<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>LOS • SCE Bill Reading Training</title>
  <meta name="theme-color" content="#0b1017"/>

  <style>
    :root{
      /* LOS brand colors (from your logo) */
      --navy:#0b1017;
      --navy2:#081a33;

      --gold:#FBC909;     /* sun */
      --orange:#F59E0B;   /* warm glow */
      --lime:#B7F40B;     /* lightning lime */
      --cyan:#00C2FF;     /* sky */
      --teal:#3AADBB;     /* blend */

      /* Dark theme surfaces */
      --bg:#070b12;
      --bg2:#0a101a;
      --card: rgba(12,18,30,.78);
      --card2: rgba(10,16,26,.70);

      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.66);
      --muted2: rgba(255,255,255,.50);

      --line: rgba(255,255,255,.10);
      --line2: rgba(255,255,255,.14);

      --shadow: 0 22px 70px rgba(0,0,0,.55);
      --shadow2: 0 14px 34px rgba(0,0,0,.45);

      --r:18px;
      --r2:24px;

      --safeT: env(safe-area-inset-top);
      --safeB: env(safe-area-inset-bottom);
      --safeL: env(safe-area-inset-left);
      --safeR: env(safe-area-inset-right);

      --accent: linear-gradient(135deg, var(--gold), var(--lime) 35%, var(--cyan) 70%, var(--teal));
      --accentSoft: linear-gradient(90deg, rgba(251,201,9,.14), rgba(183,244,11,.10), rgba(0,194,255,.12), rgba(58,173,187,.10));
      --ring: 0 0 0 4px rgba(0,194,255,.22);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(251,201,9,.16), transparent 60%),
        radial-gradient(900px 600px at 95% 5%, rgba(0,194,255,.14), transparent 55%),
        radial-gradient(900px 650px at 60% 120%, rgba(58,173,187,.12), transparent 55%),
        radial-gradient(900px 700px at 10% 120%, rgba(183,244,11,.10), transparent 55%),
        var(--bg);
      overflow-x:hidden;
    }

    button{font:inherit}

    /* Top bar */
    .top{
      position:sticky; top:0; z-index:50;
      padding: calc(12px + var(--safeT)) calc(14px + var(--safeR)) 12px calc(14px + var(--safeL));
      background: rgba(7,11,18,.72);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--line);
    }
    .topInner{
      max-width:1200px; margin:0 auto;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{
      display:flex; gap:10px; align-items:center; min-width:0;
    }
    .brand img{
      width:46px; height:46px; object-fit:contain;
      filter: drop-shadow(0 14px 26px rgba(0,0,0,.55));
    }
    .brandTitle{min-width:0}
    .brandTitle .h{
      font-weight:950; letter-spacing:.2px; line-height:1.05;
      font-size:16px;
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .pill{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      color: var(--muted);
      white-space:nowrap;
    }
    .brandTitle .s{
      font-size:12px; color:var(--muted); line-height:1.2;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      max-width: 52vw;
    }

    .topRight{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }
    .progressWrap{
      display:flex; gap:10px; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      box-shadow: var(--shadow2);
    }
    .progressBar{
      width:160px; max-width:30vw;
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      overflow:hidden;
      position:relative;
    }
    .progressBar > i{
      display:block; height:100%;
      width:0%;
      background: var(--accent);
      border-radius:999px;
      transition: width .35s ease;
    }
    .progressPct{
      font-size:12px; font-weight:900; color:rgba(255,255,255,.86);
      min-width:40px; text-align:right;
    }

    .btn{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      display:inline-flex; align-items:center; gap:8px;
      box-shadow: var(--shadow2);
      cursor:pointer;
      transition: transform .08s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
      white-space:nowrap;
    }
    .btn:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.16);
    }
    .btn:active{transform: translateY(1px)}
    .btn:focus{outline:none; box-shadow: var(--ring), var(--shadow2)}
    .btnPrimary{
      border:none;
      background: var(--accent);
      color: rgba(11,16,23,.96);
      font-weight:950;
    }
    .btnPrimary:hover{filter: brightness(1.02)}
    .btnSmall{padding:9px 10px; border-radius:12px; font-size:13px}

    /* Main layout */
    .wrap{
      max-width:1200px; margin:0 auto;
      padding: 18px calc(14px + var(--safeR)) calc(18px + var(--safeB)) calc(14px + var(--safeL));
    }

    .panel{
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .controls{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding: 12px 12px;
      background:
        radial-gradient(700px 220px at 20% 0%, rgba(251,201,9,.10), transparent 60%),
        radial-gradient(700px 220px at 90% 0%, rgba(0,194,255,.10), transparent 60%),
        rgba(255,255,255,.03);
      border-bottom: 1px solid var(--line);
      flex-wrap:wrap;
    }

    .lessonTabs{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      display:inline-flex; gap:8px; align-items:center;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .tab:hover{background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.16)}
    .tab:active{transform: translateY(1px)}
    .tab.active{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.09);
      color: rgba(255,255,255,.92);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.16);
    }
    .tab.active .dot{
      background: var(--accent);
    }

    .navButtons{display:flex; gap:8px; align-items:center; flex-wrap:wrap}

    .content{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
      padding: 14px;
      align-items:start;
    }

    .billCard, .notesCard{
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: 0 16px 40px rgba(0,0,0,.34);
      overflow:hidden;
    }

    .billHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .billHead .title{
      font-weight:950; letter-spacing:.2px;
    }
    .billHead .sub{
      font-size:12px; color:var(--muted); font-weight:750;
    }

    .pager{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      justify-content:flex-end;
    }

    .imgWrap{
      padding: 12px;
      background: rgba(0,0,0,.12);
    }
    .billImg{
      width:100%;
      height:auto;
      display:block;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 20px 55px rgba(0,0,0,.45);
      background:#0b1017;
    }

    .thumbs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding: 0 12px 12px;
    }
    .thumb{
      width:64px; height:64px;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background:#0b1017;
      box-shadow: 0 10px 22px rgba(0,0,0,.35);
      cursor:pointer;
      position:relative;
    }
    .thumb img{width:100%; height:100%; object-fit:cover}
    .thumb.active{outline:none; box-shadow: var(--ring), 0 10px 22px rgba(0,0,0,.45)}
    .thumb .n{
      position:absolute; left:7px; top:7px;
      font-size:11px; font-weight:950;
      padding:3px 7px;
      border-radius:999px;
      color:rgba(255,255,255,.96);
      background: rgba(11,16,23,.82);
      border: 1px solid rgba(255,255,255,.16);
    }

    .notesHead{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--line);
      background:
        radial-gradient(700px 280px at 10% 0%, rgba(251,201,9,.10), transparent 55%),
        radial-gradient(650px 260px at 95% 0%, rgba(0,194,255,.10), transparent 55%),
        rgba(255,255,255,.04);
    }
    .notesHead .kicker{
      font-size:12px; font-weight:950; letter-spacing:.22px;
      color: rgba(255,255,255,.66);
      text-transform:uppercase;
    }
    .notesHead .h{
      margin-top:4px;
      font-size:16px; font-weight:980;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .badge{
      font-size:12px;
      font-weight:950;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.78);
      white-space:nowrap;
    }
    .notesHead .s{
      margin-top:6px;
      font-size:12px; color:var(--muted); font-weight:700;
      line-height:1.35;
    }

    .steps{
      padding: 12px 12px 14px;
      display:flex; flex-direction:column; gap:10px;
    }
    .step{
      display:flex; gap:10px; align-items:flex-start;
      padding: 10px 10px;
      border-radius: 16px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 12px 24px rgba(0,0,0,.28);
    }
    .num{
      min-width:34px; height:34px;
      display:grid; place-items:center;
      border-radius: 12px;
      font-weight:980;
      color: rgba(11,16,23,.96);
      background: var(--accent);
      box-shadow: 0 14px 26px rgba(0,0,0,.45);
    }
    .step .t{
      font-weight:980;
      line-height:1.15;
      margin-top:2px;
      color: rgba(255,255,255,.92);
    }
    .step .d{
      margin-top:4px;
      font-size:12px;
      color: rgba(255,255,255,.70);
      line-height:1.35;
      font-weight:700;
    }

    .cta{
      margin-top: 4px;
      padding: 12px;
      border-top: 1px solid var(--line);
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      background: rgba(255,255,255,.03);
    }
    .cta .left{
      display:flex; flex-direction:column; gap:4px;
    }
    .cta .left .t{font-weight:980}
    .cta .left .s{font-size:12px; color:var(--muted); font-weight:700}

    /* Quiz */
    .quiz{
      margin-top: 14px;
      padding: 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .quizHead{
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
      padding: 6px 2px 12px;
    }
    .quizHead .h{
      font-weight:980; font-size:16px;
    }
    .quizHead .s{
      font-size:12px; color:var(--muted); font-weight:700; margin-top:4px; line-height:1.35;
      max-width: 720px;
    }
    .qList{display:flex; flex-direction:column; gap:10px}
    .q{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 12px 24px rgba(0,0,0,.28);
    }
    .q .qt{font-weight:980; line-height:1.2}
    .opts{margin-top:10px; display:grid; gap:8px}
    .opt{
      display:flex; gap:10px; align-items:flex-start;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
    }
    .opt:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.14);
    }
    .opt:active{transform: translateY(1px)}
    .opt input{margin-top:2px}
    .quizFoot{
      margin-top: 12px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .score{
      font-weight:980;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      display:inline-flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .score strong{
      font-size:14px;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
    }

    /* Responsive */
    @media (max-width: 980px){
      .content{grid-template-columns: 1fr;}
      .brandTitle .s{max-width: 72vw}
      .progressBar{width:140px}
    }
    @media (max-width: 520px){
      .progressWrap{display:none}
      .thumb{width:58px; height:58px}
      .tab{padding:10px 11px}
      .btn{padding:10px 11px}
      .content{padding: 12px}
      .imgWrap{padding: 10px}
    }
  </style>
</head>

<body>
  <header class="top">
    <div class="topInner">
      <div class="brand">
        <img id="logoImg" src="Logo.png" alt="LOS logo" onerror="this.style.display='none'">
        <div class="brandTitle">
          <div class="h">
            LOS • SCE Bill Reading
            <span class="pill" id="lessonPill">Lesson 1 of 4</span>
          </div>
          <div class="s" id="lessonSubtitle">Learn what matters on the bill — top to bottom — so you can book a consult.</div>
        </div>
      </div>

      <div class="topRight">
        <div class="progressWrap" title="Completion progress">
          <div class="progressBar"><i id="progressFill"></i></div>
          <div class="progressPct" id="progressPct">0%</div>
        </div>
        <button class="btn btnSmall" id="resetBtn" title="Reset progress">↺ Reset</button>
        <button class="btn btnPrimary btnSmall" id="quizJumpBtn" title="Jump to quiz">✓ Quiz</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="controls">
        <div class="lessonTabs" id="lessonTabs"></div>

        <div class="navButtons">
          <button class="btn btnSmall" id="prevLessonBtn">← Prev lesson</button>
          <button class="btn btnSmall" id="nextLessonBtn">Next lesson →</button>
        </div>
      </div>

      <div class="content">
        <!-- BILL -->
        <div class="billCard">
          <div class="billHead">
            <div>
              <div class="title" id="billTitle">Bill</div>
              <div class="sub" id="billSub">Page 1</div>
            </div>

            <div class="pager">
              <button class="btn btnSmall" id="prevPageBtn">← Page</button>
              <button class="btn btnSmall" id="nextPageBtn">Page →</button>
            </div>
          </div>

          <div class="imgWrap">
            <img class="billImg" id="billImg" alt="Bill image">
          </div>

          <div class="thumbs" id="thumbs"></div>
        </div>

        <!-- NOTES -->
        <div class="notesCard">
          <div class="notesHead">
            <div class="kicker">What to explain (top → bottom)</div>
            <div class="h">
              <span id="notesTitle">Lesson Notes</span>
              <span class="badge" id="lessonTypeBadge">SCE</span>
            </div>
            <div class="s" id="notesIntro">
              Hit the “pain” points that create extra bills, then bridge to a consult: “Let’s review your bill + usage pattern and confirm the fix.”
            </div>
          </div>

          <div class="steps" id="steps"></div>

          <div class="cta">
            <div class="left">
              <div class="t">Appointment close line</div>
              <div class="s" id="closeLine">“If we can show why this bill happened and what fixes it, would a 15–20 min consult tomorrow work?”</div>
            </div>
            <button class="btn btnPrimary" id="markDoneBtn">Mark lesson complete ✓</button>
          </div>
        </div>
      </div>
    </section>

    <!-- QUIZ -->
    <section class="quiz" id="quiz">
      <div class="quizHead">
        <div>
          <div class="h">Quick Knowledge Check</div>
          <div class="s">
            Answer these based on what you learned. When all answers are correct, you’ll see <b>100% complete</b>.
          </div>
        </div>
        <div class="score">
          Score: <strong id="scorePct">0%</strong>
          <span id="scoreMsg" style="font-size:12px;color:var(--muted);font-weight:700;">Finish the quiz to complete training.</span>
        </div>
      </div>

      <div class="qList" id="qList"></div>

      <div class="quizFoot">
        <button class="btn" id="checkQuizBtn">Check answers</button>
        <button class="btn btnPrimary" id="finishBtn">Finish / Save progress</button>
      </div>
    </section>
  </main>

  <script>
    /* =========================
       LESSON DATA
       ========================= */
    const lessons = [
      {
        id: "addon",
        name: "Add-on (Solar + bill)",
        type: "Solar add-on • NEM-style annual / true-up risk",
        badge: "ADD-ON",
        pages: ["Add-on-page1.jpeg","Addonpage2.jpeg","Add-on-bill3.jpg"],
        notesTitle: "Add-on Solar Bill (Victor Barba) — What creates extra bills?",
        intro: "This is the “I have solar… why did I get billed?” lesson. Identify true-up, TOU timing, minimum/NBCs, or usage changes — then book a consult.",
        closeLine: "“This looks like an annual / TOU timing issue more than ‘solar not working.’ Let’s do a quick consult to confirm the fix and protect you from a big true-up.”",
        steps: [
          {t:"Billing period + where they are in the annual cycle", d:"Find settlement messaging (billing month X of 12). Customers think solar means $0 monthly—set expectations."},
          {t:"Account summary: credit vs new charges", d:"Credits can exist while new charges still apply (minimums / delivery / NBCs)."},
          {t:"Annual bill / true-up box", d:"Highlight year-to-date charges + settlement timing. That’s the pain driver."},
          {t:"TOU schedule", d:"Expensive hours can still drive cost if usage is heavy when solar isn’t producing."},
          {t:"Usage section: total kWh + trend", d:"If usage is up (EV/pool/AC), system may be undersized vs lifestyle changes."},
          {t:"Details of new charges: delivery + NBCs", d:"Show why some charges remain. Keep it simple."},
          {t:"Consult bridge", d:"Book consult to map usage timing + credits + system design and show the best fix (add panels vs battery)."}
        ]
      },
      {
        id: "yucaipa",
        name: "Yucaipa (No solar • TOU)",
        type: "No solar • High bill • TOU pain",
        badge: "YUCAIPA",
        pages: ["Yucaipapage1.jpeg","Yucaipa2.jpg","Yucaipa3.jpg"],
        notesTitle: "No Solar Bill (Yucaipa) — Perfect ‘pain’ consult setup",
        intro: "Anchor on amount due and TOU peak. Then explain usage buckets, trends, and charge categories to justify the consult.",
        closeLine: "“This is exactly what we solve — let’s do a 15–20 minute consult to confirm your TOU exposure and show day-one savings options.”",
        steps: [
          {t:"Amount due (start here)", d:"Start with the big number and due date. That’s the emotional hook."},
          {t:"Account summary", d:"Separate past due vs new charges so the customer understands the story."},
          {t:"TOU schedule (peak window)", d:"Explain that peak hours cost more; timing matters."},
          {t:"Usage buckets (kWh)", d:"Identify which bucket drives cost (often peak)."},
          {t:"Total usage + trend graph", d:"If usage climbs, bills will keep rising. Tie to lifestyle/season."},
          {t:"Details of new charges", d:"Delivery vs generation + adders. Rates increase outside the customer’s control."},
          {t:"Consult bridge", d:"Book consult to size solar + storage to reduce peak pain."}
        ]
      },
      {
        id: "dcare",
        name: "Tiered (D-CARE)",
        type: "Tiered bill • Baseline/Tier 1/2 pricing",
        badge: "D-CARE",
        pages: ["Dcaretiersbill.jpeg"],
        notesTitle: "Tiered D-CARE Bill — Why it spikes when usage climbs",
        intro: "Tier bills punish over-baseline usage. Show Tier 2 kWh and Tier 2 price to create the ‘aha’.",
        closeLine: "“Once you cross baseline, every extra kWh costs more. Let’s do a quick consult to size solar to keep you out of Tier 2.”",
        steps: [
          {t:"Rate name + billing period", d:"Confirm it’s tiered (baseline + over-baseline)."},
          {t:"Tier 1 vs Tier 2 kWh", d:"Point out the split and where most kWh land."},
          {t:"Tier 2 $/kWh (pain)", d:"Show the price jump. That’s why the bill feels unfair."},
          {t:"Delivery + generation can both tier", d:"High usage impacts multiple sections."},
          {t:"Consult bridge", d:"Find what’s driving Tier 2 and size solar to reduce that exposure."}
        ]
      },
      {
        id: "nem3",
        name: "NEM 3.0 (Solar + battery)",
        type: "NEM 3.0 • Timing matters • exports worth less",
        badge: "NEM 3.0",
        pages: ["Nem3bill.jpg"],
        notesTitle: "NEM 3.0 — Why the total can be low (and what to watch)",
        intro: "NEM 3.0 is about timing: batteries help reduce peak imports. Even ‘good’ months can have minimum/delivery charges.",
        closeLine: "“This is a good result — but timing is everything on NEM 3.0. Let’s confirm peak imports and make sure you stay protected year-round.”",
        steps: [
          {t:"Total + charges vs credits", d:"Explain that credits offset charges; read net result."},
          {t:"TOU buckets (peak)", d:"Even small peak imports can create bills over time."},
          {t:"Usage trend", d:"Lifestyle changes can break the model (EV/pool)."},
          {t:"Delivery/program fees", d:"Set expectation: some charges remain even with solar+battery."},
          {t:"Consult bridge", d:"Confirm battery schedule, TOU plan, and peak avoidance strategy."}
        ]
      }
    ];

    /* =========================
       QUIZ
       ========================= */
    const quizQuestions = [
      { q:"On solar bills, what often explains why you may still get billed?", a:1,
        opts:["Mailing address","Annual bill / settlement (billing month X of 12)","QR code","Font size"] },
      { q:"For TOU, what drives appointments most?", a:2,
        opts:["All kWh cost the same","Solar covers all hours equally","Peak hours cost more; timing creates big charges","Tiers are the same as TOU"] },
      { q:"On tiered (D-CARE), what causes the bill to jump?", a:1,
        opts:["QR code","Crossing baseline into Tier 2 ($/kWh higher)","Different paper","Only base charge"] },
      { q:"On NEM 3.0, what’s the key risk even if total looks small?", a:3,
        opts:["TOU removed","Credits always increase","Exports always worth more","Peak imports + timing can still create bills"] }
    ];

    /* =========================
       STATE
       ========================= */
    const $ = (sel)=>document.querySelector(sel);
    const storageKey = "los_bill_training_dark_v1";
    let state = { lessonIndex:0, pageIndex:0, completed:{}, quiz:{} };

    function loadState(){
      try{
        const raw = localStorage.getItem(storageKey);
        if(raw) state = { ...state, ...JSON.parse(raw) };
      }catch(e){}
    }
    function saveState(){
      try{ localStorage.setItem(storageKey, JSON.stringify(state)); }catch(e){}
    }

    function calcQuizScorePct(){
      const total = quizQuestions.length;
      let correct = 0;
      for(let i=0;i<total;i++){
        const sel = state.quiz?.[i];
        if(typeof sel === "number" && sel === quizQuestions[i].a) correct++;
      }
      return correct/total; // 0..1
    }
    function calcCompletionPct(){
      const doneLessons = Object.values(state.completed||{}).filter(Boolean).length;
      const lessonPct = (doneLessons/lessons.length)*70;
      const quizPct = calcQuizScorePct()*30*100; // percent points
      return Math.round(lessonPct + quizPct);
    }

    function updateProgressUI(){
      const pct = calcCompletionPct();
      $("#progressFill").style.width = pct + "%";
      $("#progressPct").textContent = pct + "%";
    }

    function setLesson(i){
      state.lessonIndex = Math.max(0, Math.min(lessons.length-1, i));
      state.pageIndex = 0;
      saveState();
      render();
      window.scrollTo({top:0, behavior:"smooth"});
    }
    function setPage(i){
      const lesson = lessons[state.lessonIndex];
      state.pageIndex = Math.max(0, Math.min(lesson.pages.length-1, i));
      saveState();
      renderBill();
      renderThumbs();
    }

    function render(){
      renderTabs();
      renderHeader();
      renderBill();
      renderThumbs();
      renderNotes();
      renderQuiz();
      updateProgressUI();
    }

    function renderHeader(){
      const lesson = lessons[state.lessonIndex];
      $("#lessonPill").textContent = `Lesson ${state.lessonIndex+1} of ${lessons.length}`;
      $("#lessonSubtitle").textContent = lesson.type;
    }

    function renderTabs(){
      const tabs = $("#lessonTabs");
      tabs.innerHTML = "";
      lessons.forEach((l, i)=>{
        const b = document.createElement("button");
        b.className = "tab" + (i===state.lessonIndex ? " active":"");
        b.innerHTML = `<span class="dot"></span>${l.name}`;
        b.onclick = ()=>setLesson(i);
        tabs.appendChild(b);
      });
    }

    function renderBill(){
      const lesson = lessons[state.lessonIndex];
      const src = lesson.pages[state.pageIndex];

      $("#billTitle").textContent = lesson.name;
      $("#billSub").textContent = `Page ${state.pageIndex+1} of ${lesson.pages.length}`;

      const img = $("#billImg");
      img.style.borderColor = "rgba(255,255,255,.12)";
      img.style.boxShadow = "0 20px 55px rgba(0,0,0,.45)";
      img.style.opacity = "1";
      img.style.filter = "none";
      img.src = src;

      img.onerror = () => {
        img.alt = "Image not found. Check filename + path.";
        img.style.borderColor = "rgba(239,68,68,.55)";
        img.style.boxShadow = "0 20px 55px rgba(239,68,68,.18)";
        img.style.opacity = ".85";
      };

      $("#prevPageBtn").disabled = state.pageIndex === 0;
      $("#nextPageBtn").disabled = state.pageIndex === (lesson.pages.length-1);
      $("#prevPageBtn").onclick = ()=>setPage(state.pageIndex-1);
      $("#nextPageBtn").onclick = ()=>setPage(state.pageIndex+1);

      $("#prevLessonBtn").disabled = state.lessonIndex === 0;
      $("#nextLessonBtn").disabled = state.lessonIndex === (lessons.length-1);
      $("#prevLessonBtn").onclick = ()=>setLesson(state.lessonIndex-1);
      $("#nextLessonBtn").onclick = ()=>setLesson(state.lessonIndex+1);
    }

    function renderThumbs(){
      const lesson = lessons[state.lessonIndex];
      const thumbs = $("#thumbs");
      thumbs.innerHTML = "";
      if(lesson.pages.length <= 1) return;

      for(let i=0;i<lesson.pages.length;i++){
        const t = document.createElement("div");
        t.className = "thumb" + (i===state.pageIndex ? " active":"");
        t.innerHTML = `<span class="n">${i+1}</span><img alt="thumb ${i+1}" src="${lesson.pages[i]}">`;
        t.onclick = ()=>setPage(i);
        thumbs.appendChild(t);
      }
    }

    function renderNotes(){
      const lesson = lessons[state.lessonIndex];

      $("#notesTitle").textContent = lesson.notesTitle;
      $("#lessonTypeBadge").textContent = lesson.badge;
      $("#notesIntro").textContent = lesson.intro;
      $("#closeLine").textContent = lesson.closeLine;

      const steps = $("#steps");
      steps.innerHTML = "";
      lesson.steps.forEach((s, idx)=>{
        const row = document.createElement("div");
        row.className = "step";
        row.innerHTML = `
          <div class="num">${idx+1}</div>
          <div>
            <div class="t">${s.t}</div>
            <div class="d">${s.d}</div>
          </div>
        `;
        steps.appendChild(row);
      });

      const done = !!state.completed?.[lesson.id];
      $("#markDoneBtn").textContent = done ? "Lesson completed ✓" : "Mark lesson complete ✓";
      $("#markDoneBtn").onclick = ()=>{
        state.completed = state.completed || {};
        state.completed[lesson.id] = true;
        saveState();
        updateProgressUI();
        $("#markDoneBtn").textContent = "Lesson completed ✓";
      };
    }

    function renderQuiz(){
      const list = $("#qList");
      list.innerHTML = "";

      quizQuestions.forEach((q, qi)=>{
        const wrap = document.createElement("div");
        wrap.className = "q";
        wrap.innerHTML = `<div class="qt">${qi+1}. ${q.q}</div>`;
        const opts = document.createElement("div");
        opts.className = "opts";

        q.opts.forEach((txt, oi)=>{
          const id = `q${qi}_o${oi}`;
          const row = document.createElement("label");
          row.className = "opt";
          row.htmlFor = id;
          row.innerHTML = `
            <input type="radio" name="q${qi}" id="${id}" ${state.quiz?.[qi]===oi ? "checked":""}>
            <div style="font-weight:800;color:rgba(255,255,255,.86);line-height:1.25">${txt}</div>
          `;
          row.querySelector("input").addEventListener("change", ()=>{
            state.quiz = state.quiz || {};
            state.quiz[qi] = oi;
            saveState();
          });
          opts.appendChild(row);
        });

        wrap.appendChild(opts);
        list.appendChild(wrap);
      });

      $("#checkQuizBtn").onclick = ()=>{
        const pct = Math.round(calcQuizScorePct()*100);
        $("#scorePct").textContent = pct + "%";
        $("#scoreMsg").textContent = (pct===100)
          ? "Perfect — training complete."
          : "Close — fix the missed ones and re-check.";
        updateProgressUI();
        $("#quiz").scrollIntoView({behavior:"smooth", block:"start"});
      };

      $("#finishBtn").onclick = ()=>{
        const pct = Math.round(calcQuizScorePct()*100);
        if(pct===100){
          state.completed = state.completed || {};
          lessons.forEach(l=>state.completed[l.id]=true);
        }
        saveState();
        updateProgressUI();
        const total = calcCompletionPct();
        alert(total===100 ? "100% COMPLETE ✅" : `Progress saved: ${total}%`);
      };

      $("#quizJumpBtn").onclick = ()=>$("#quiz").scrollIntoView({behavior:"smooth", block:"start"});
    }

    $("#resetBtn").onclick = ()=>{
      if(!confirm("Reset progress + quiz answers?")) return;
      state.completed = {};
      state.quiz = {};
      saveState();
      render();
    };

    (function init(){
      loadState();
      if(state.lessonIndex<0 || state.lessonIndex>=lessons.length) state.lessonIndex=0;
      if(!Number.isFinite(state.pageIndex)) state.pageIndex=0;
      render();
    })();
  </script>
</body>
</html>
