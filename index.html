<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>LOS • Edison Bill Training</title>
  <meta name="theme-color" content="#0b1017"/>

  <style>
    :root{
      --bg:#0b1017;
      --panel:#0f1826;
      --panel2:#0c1522;
      --ink:rgba(255,255,255,.96);
      --muted:rgba(255,255,255,.68);
      --line:rgba(255,255,255,.10);

      --gold:#FBC909;
      --teal:#3AADBB;

      --shadow: 0 18px 70px rgba(0,0,0,.45);
      --r:16px;
      --r2:22px;

      --safeT: env(safe-area-inset-top);
      --safeB: env(safe-area-inset-bottom);
      --safeL: env(safe-area-inset-left);
      --safeR: env(safe-area-inset-right);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif}
    .container{
      max-width:1200px;margin:0 auto;
      padding:14px;
      padding-left:calc(14px + var(--safeL));
      padding-right:calc(14px + var(--safeR));
      padding-bottom:calc(14px + var(--safeB));
    }

    /* Top bar */
    .topbar{
      position:sticky;top:0;z-index:50;
      background:rgba(11,16,23,.86);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--line);
      padding:12px 14px;
      padding-top:calc(12px + var(--safeT));
      display:flex;gap:12px;align-items:center;justify-content:space-between;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:44px;height:44px;object-fit:contain;border-radius:12px;
      border:1px solid var(--line);background:rgba(255,255,255,.04)
    }
    .brandTitle{font-weight:950;letter-spacing:.2px;line-height:1.1}
    .brandSub{font-size:12px;color:var(--muted);margin-top:2px}

    /* Tabs */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .tab{
      text-decoration:none;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:14px;
      font-weight:900;
      transition:transform .12s ease,border-color .12s ease,background .12s ease,color .12s ease;
      white-space:nowrap;
    }
    .tab:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.05);color:var(--ink)}
    .tab.active{
      color:var(--ink);
      border-color:rgba(58,173,187,.55);
      background:rgba(58,173,187,.10);
      box-shadow:0 10px 24px rgba(58,173,187,.12);
    }

    /* Layout */
    .page{display:none}
    .page.active{display:block}

    .card{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:var(--r2);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      padding:14px;
    }
    .cardHeader{display:flex;gap:10px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .title{margin:0;font-size:18px;font-weight:950}
    .tag{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      border-radius:999px;padding:7px 10px;background:rgba(255,255,255,.03);
    }
    .muted{color:var(--muted);line-height:1.45;margin:8px 0 0}
    .divider{height:1px;background:var(--line);margin:12px 0}

    /* Bill viewer */
    .viewerWrap{display:grid;gap:12px}
    @media (min-width: 980px){
      .viewerWrap{grid-template-columns: 7fr 5fr;align-items:start}
    }

    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .leftRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    select{
      appearance:none;border:1px solid var(--line);
      border-radius:12px;padding:10px 12px;font-size:14px;
      background:rgba(255,255,255,.03);color:var(--ink);
      box-shadow:0 8px 18px rgba(0,0,0,.25);
      font-weight:900;
    }
    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      border-radius:999px;padding:7px 10px;background:rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--ink);
      padding:10px 12px;border-radius:12px;font-weight:950;
      cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.25);
      transition:transform .12s ease, border-color .12s ease, background .12s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.05)}
    .btnPrimary{background:linear-gradient(135deg,var(--gold),var(--teal));border-color:transparent;color:#06122a}
    .btnSmall{padding:8px 10px;border-radius:10px}
    .btnToggleOn{
      border-color:rgba(251,201,9,.55);
      background:rgba(251,201,9,.12);
    }

    .viewerShell{
      border:1px solid var(--line);
      border-radius:var(--r2);
      overflow:hidden;
      background:#000;
      box-shadow:var(--shadow);
      height:62vh;min-height:420px;
      position:relative;
    }
    @media (min-width: 980px){
      .viewerShell{height:72vh;min-height:520px}
    }

    /* PDF */
    iframe#pdfFrame{width:100%;height:100%;border:0;background:#000;display:none}

    /* Snapshot image stage: standard fit + consistent zoom */
    .imgStage{position:absolute;inset:0;overflow:hidden;background:#000;display:none}
    .imgCanvas{
      position:absolute;left:50%;top:50%;
      transform-origin:0 0; /* we use translate(-50%,-50%) then scale */
      will-change:transform;
    }
    .imgCanvas img{display:block;width:100%;height:100%;user-select:none;-webkit-user-drag:none;pointer-events:none}

    /* Callouts */
    .calloutLayer{
      position:absolute;inset:0;
      pointer-events:none;
      z-index:6;
    }
    .dot{
      position:absolute;
      width:22px;height:22px;border-radius:50%;
      background:linear-gradient(135deg,var(--gold),var(--teal));
      box-shadow:0 0 0 6px rgba(251,201,9,.22);
      cursor:pointer;
      pointer-events:auto;
    }
    .dot::after{
      content:"+";
      position:absolute;inset:0;
      display:flex;align-items:center;justify-content:center;
      font-weight:950;color:#06122a;
    }

    /* Popup */
    .popup{
      position:fixed;left:16px;right:16px;bottom:16px;
      background:rgba(15,24,38,.96);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow:0 20px 60px rgba(0,0,0,.6);
      z-index:9999;
      backdrop-filter: blur(10px);
    }
    @media (min-width: 980px){
      .popup{left:auto;right:20px;bottom:20px;max-width:420px}
    }
    .popup h4{margin:0 0 6px;font-size:16px}
    .popup p{margin:0;color:var(--muted);line-height:1.4}
    .popup .prow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .popup .prow .btn{width:100%}
    @media (min-width: 980px){
      .popup .prow .btn{width:auto}
    }

    /* Right panel */
    .side{
      border:1px solid var(--line);
      border-radius:var(--r2);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      padding:14px;
    }
    .side h3{margin:0 0 6px;font-size:16px}
    .list{margin:10px 0 0;padding:0;list-style:none;display:grid;gap:10px}
    .item{
      border:1px solid var(--line);
      border-radius:14px;padding:12px;
      background:
        radial-gradient(600px 220px at 0% 0%, rgba(251,201,9,.10), transparent 55%),
        radial-gradient(600px 220px at 100% 0%, rgba(58,173,187,.08), transparent 55%),
        rgba(255,255,255,.02);
    }
    .item b{color:var(--ink)}
    .item small{display:block;color:var(--muted);margin-top:6px;line-height:1.35}

    /* Training blocks */
    details.block{border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.02);overflow:hidden}
    details.block + details.block{margin-top:10px}
    details.block summary{
      list-style:none;cursor:pointer;padding:12px 12px;
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
      user-select:none;font-weight:950;color:var(--ink);
    }
    details.block summary::-webkit-details-marker{display:none}
    .caret{
      width:10px;height:10px;border-right:2px solid rgba(255,255,255,.45);border-bottom:2px solid rgba(255,255,255,.45);
      transform:rotate(45deg);margin-top:6px;transition:transform .12s ease;flex:0 0 auto;
    }
    details[open] .caret{transform:rotate(225deg);margin-top:10px}
    .body{padding:0 12px 12px;color:var(--muted);line-height:1.45}
    .body ul{margin:8px 0 0 18px}
    .body li{margin:7px 0}

    /* Footer */
    .footer{margin:16px 0 10px;color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <img src="Logo.png" class="logo" alt="Leverage Our Sun"/>
      <div>
        <div class="brandTitle">LOS Rep Training</div>
        <div class="brandSub">Edison bill mastery • Solar + Batteries</div>
      </div>
    </div>

    <nav class="tabs" id="tabs">
      <a class="tab active" href="#bill">Bill Knowledge</a>
      <a class="tab" href="#approach">Approach</a>
      <a class="tab" href="#growth">Self Growth</a>
    </nav>
  </header>

  <main class="container">

    <!-- BILL KNOWLEDGE PAGE -->
    <section class="page active" id="page-bill">
      <section class="card">
        <div class="cardHeader">
          <h2 class="title">Bill Knowledge</h2>
          <span class="tag">Tap dots → zoom → learn</span>
        </div>

        <div class="divider"></div>

        <div class="viewerWrap">
          <div>
            <div class="row">
              <div class="leftRow">
                <select id="billSelect" aria-label="Select bill type">
                  <option value="tou">TOU – Domestic (no solar)</option>
                  <option value="nem2">NEM 2.0 (solar)</option>
                  <option value="nem3">NEM 3.0 (solar)</option>
                  <option value="dcare">DCARE – Tiers (no solar)</option>
                </select>
                <span class="pill" id="pagePill">Page 1 / 3</span>
              </div>

              <div class="leftRow">
                <button class="btn btnSmall" id="fitBtn" title="Reset view">Fit</button>
                <button class="btn btnSmall" id="openBtn">Open</button>
                <button class="btn btnSmall" id="prevBtn">Prev</button>
                <button class="btn btnSmall btnPrimary" id="nextBtn">Next</button>
              </div>
            </div>

            <div class="divider"></div>

            <div class="viewerShell" id="viewerShell">
              <iframe id="pdfFrame" title="PDF Viewer"></iframe>

              <div class="imgStage" id="imgStage">
                <div class="imgCanvas" id="imgCanvas">
                  <img id="imgEl" alt="Snapshot"/>
                  <div class="calloutLayer" id="calloutLayerImg"></div>
                </div>
              </div>

              <!-- PDF callouts overlay (page 1 only) -->
              <div class="calloutLayer" id="calloutLayerPdf"></div>
            </div>
          </div>

          <aside class="side">
            <h3>Quick reps rules</h3>
            <ul class="list">
              <li class="item">
                <b>Non-solar</b>
                <small>Teach: delivery vs generation + TOU (when) + usage (kWh).</small>
              </li>
              <li class="item">
                <b>Solar still paying</b>
                <small>Teach: imports vs credits + TOU. Battery = avoid buying at peak.</small>
              </li>
              <li class="item">
                <b>Close</b>
                <small>“If it doesn’t save day 1, we stop. Today or tomorrow for 30–45 min?”</small>
              </li>
            </ul>
          </aside>
        </div>
      </section>
    </section>

    <!-- APPROACH PAGE -->
    <section class="page" id="page-approach">
      <section class="card">
        <div class="cardHeader">
          <h2 class="title">Approach</h2>
          <span class="tag">Simple • calm • book the consult</span>
        </div>

        <details class="block" open>
          <summary>
            Door structure (always)
            <span class="caret"></span>
          </summary>
          <div class="body">
            <ul>
              <li><b>Intro:</b> “Hey — I’m with LOS, working on the power projects out here.”</li>
              <li><b>Problem:</b> “Edison is expensive because of <b>how much</b> and <b>when</b>.”</li>
              <li><b>Solution:</b> “Solar handles usage. Batteries handle peak + outages.”</li>
              <li><b>Transition:</b> “Let’s verify with your bill and usage.”</li>
              <li><b>Assume sale:</b> “Today or tomorrow for 30–45 minutes?”</li>
            </ul>
          </div>
        </details>

        <details class="block">
          <summary>
            Tone + body language
            <span class="caret"></span>
          </summary>
          <div class="body">
            <ul>
              <li>Slow down. Short sentences. Ask one question at a time.</li>
              <li>Hands visible. Relax shoulders. Stand angled, give space.</li>
              <li>Down-tone for certainty. Up-tone only for questions.</li>
            </ul>
          </div>
        </details>

        <details class="block">
          <summary>
            What to collect at the door
            <span class="caret"></span>
          </summary>
          <div class="body">
            <ul>
              <li>Rate plan (TOU / Tier / DCARE)</li>
              <li>Monthly kWh usage + peak hour pattern</li>
              <li>If solar: imports vs credits + whether evenings are still high</li>
            </ul>
          </div>
        </details>
      </section>
    </section>

    <!-- SELF GROWTH PAGE -->
    <section class="page" id="page-growth">
      <section class="card">
        <div class="cardHeader">
          <h2 class="title">Self Growth</h2>
          <span class="tag">Mental strength • consistency</span>
        </div>

        <details class="block" open>
          <summary>
            Daily (10–15 min)
            <span class="caret"></span>
          </summary>
          <div class="body">
            <ul>
              <li>Practice the close 10 times.</li>
              <li>Teach one bill page out loud (like you’re explaining to a homeowner).</li>
              <li>Set a “wins goal”: conversations, bills collected, consults booked.</li>
            </ul>
          </div>
        </details>

        <details class="block">
          <summary>
            Staying mentally strong
            <span class="caret"></span>
          </summary>
          <div class="body">
            <ul>
              <li>Control pace: breathe, slow down, reset after every door.</li>
              <li>Detach from “no” — your scoreboard is effort + volume.</li>
              <li>Protect mornings: water, sunlight, movement, simple food.</li>
            </ul>
          </div>
        </details>

        <details class="block">
          <summary>
            Weekly reset (30 min)
            <span class="caret"></span>
          </summary>
          <div class="body">
            <ul>
              <li>Review best 3 conversations → repeat what worked.</li>
              <li>Role-play objections with one teammate.</li>
              <li>Pick one skill to improve next week (tone, pace, bill explanation, close).</li>
            </ul>
          </div>
        </details>
      </section>
    </section>

    <div class="footer">
      <div>LOS • Edison Training</div>
      <div>Tip: add an empty <b>.nojekyll</b> file to repo root for GitHub Pages stability.</div>
    </div>
  </main>

  <script>
    /* =========================
       FILE RESOLUTION (JPG/PDF)
       ========================= */
    const EXT_ORDER = ["pdf","jpg","jpeg","png","webp"];

    async function urlExists(url){
      try{
        const r = await fetch(url, { method:"HEAD", cache:"no-store" });
        if(r.ok) return true;
      }catch(e){}
      try{
        const r2 = await fetch(url, { method:"GET", cache:"no-store" });
        return r2.ok;
      }catch(e){}
      return false;
    }

    async function resolveFirstExisting(baseName){
      if(baseName.includes(".")){
        return (await urlExists(baseName)) ? baseName : null;
      }
      for(const ext of EXT_ORDER){
        const candidate = `${baseName}.${ext}`;
        if(await urlExists(candidate)) return candidate;
      }
      return null;
    }

    /* =========================
       BILL DEFINITIONS
       ========================= */
    const BILLS = {
      tou: {
        pages: [
          { type:"pdf", src:"Yucaipa.pdf", pdfPage:1 },
          { type:"snap", base:"Yucaipa2" },
          { type:"snap", base:"Yucaipa3" }
        ]
      },
      nem2: {
        pages: [
          { type:"pdf", src:"Add-on-bill.pdf", pdfPage:1 },
          { type:"snap", base:"Add-on-bill2" },
          { type:"snap", base:"Add-on-bill3" }
        ]
      },
      nem3: {
        pages: [
          { type:"pdf", src:"Laminate-1-2.pdf", pdfPage:1 }
        ]
      },
      dcare: {
        pages: [
          { type:"snap", base:"Scebill" }
        ]
      }
    };

    /* =========================
       CALLOUTS (page-specific)
       - x/y = percent (0-100)
       - z = zoom multiplier for snapshots
       ========================= */
    const CALLOUTS = {
      tou: {
        1: [
          { x:22, y:74, z:1.7, t:"Delivery charges", d:"Grid + wires + programs. Solar doesn’t erase delivery." },
          { x:22, y:83, z:1.7, t:"Generation charges", d:"Energy you buy. Solar offsets this part the most." },
          { x:70, y:56, z:1.6, t:"Usage graph", d:"Bars = kWh used. Taller bar = more usage (bigger system needed)." }
        ],
        2: [
          { x:28, y:20, z:2.2, t:"TOU windows", d:"Peak is most expensive. Off-peak is cheaper. Battery avoids peak buying." },
          { x:22, y:47, z:2.0, t:"Usage by time", d:"Where the kWh happened matters. Heavy evening usage = peak pain." },
          { x:26, y:68, z:1.9, t:"Trend graph", d:"Rising usage + rate hikes = bigger problem (bigger opportunity)." }
        ],
        3: [
          { x:22, y:28, z:2.2, t:"Delivery detail", d:"This bucket stays. The goal is reduce expensive kWh (peak) + protect outages." },
          { x:22, y:55, z:2.2, t:"Generation detail", d:"This is the energy cost. Solar reduces how much you buy." }
        ]
      },
      nem2: {
        1: [
          { x:22, y:30, z:1.8, t:"Solar credits vs charges", d:"Exports earn credits. Imports cost money. TOU decides value." },
          { x:70, y:62, z:1.6, t:"TOU still matters", d:"If evenings are high, solar alone won’t cover it. Battery fixes that." }
        ],
        2: [
          { x:26, y:46, z:2.1, t:"Net use vs net generation", d:"Imports = grid power used. Net generation = extra solar sent back." },
          { x:22, y:66, z:2.0, t:"Graph", d:"If evening usage is still high, battery = avoid buying at peak." },
          { x:22, y:86, z:2.2, t:"Fees / delivery", d:"Some charges still apply (delivery + other fees). Set expectation early." }
        ],
        3: [
          { x:22, y:26, z:2.2, t:"Delivery detail", d:"Solar doesn’t delete delivery. Battery reduces peak buying." },
          { x:22, y:52, z:2.2, t:"Generation detail", d:"This is energy bought. Goal: buy less at peak." }
        ]
      },
      dcare: {
        1: [
          { x:22, y:28, z:2.0, t:"Usage trend", d:"Monthly usage pattern. Higher use pushes into higher-priced tiers." },
          { x:22, y:60, z:2.1, t:"Delivery charges", d:"Grid costs bucket. Still exists with solar." },
          { x:22, y:72, z:2.1, t:"Generation charges", d:"Energy bucket. Solar offsets this portion." },
          { x:66, y:90, z:2.0, t:"Tier pricing", d:"Higher tier = higher $/kWh. Solar reduces expensive kWh." }
        ]
      }
    };

    /* =========================
       UI ELEMENTS
       ========================= */
    const billSelect = document.getElementById("billSelect");
    const pagePill   = document.getElementById("pagePill");
    const prevBtn    = document.getElementById("prevBtn");
    const nextBtn    = document.getElementById("nextBtn");
    const openBtn    = document.getElementById("openBtn");
    const fitBtn     = document.getElementById("fitBtn");

    const pdfFrame   = document.getElementById("pdfFrame");
    const imgStage   = document.getElementById("imgStage");
    const imgCanvas  = document.getElementById("imgCanvas");
    const imgEl      = document.getElementById("imgEl");

    const calloutLayerImg = document.getElementById("calloutLayerImg");
    const calloutLayerPdf = document.getElementById("calloutLayerPdf");

    let billKey = "tou";
    let pageIndex = 1; // 1-based
    let popupEl = null;

    // PDF reload helper for iOS/Safari
    let lastPdfSrc = "";

    // Snapshot fit+zoom state
    let fitScale = 1;   // auto-fit (standard size)
    let userScale = 1;  // zoom on top of fit
    let tx = 0, ty = 0; // pan

    function closePopup(){
      if(popupEl){ popupEl.remove(); popupEl = null; }
    }
    function showPopup(title, desc){
      closePopup();
      const div = document.createElement("div");
      div.className = "popup";
      div.innerHTML = `
        <h4>${title}</h4>
        <p>${desc}</p>
        <div class="prow">
          <button class="btn btnPrimary" id="popOk">Got it</button>
          <button class="btn" id="popClose">Close</button>
        </div>
      `;
      document.body.appendChild(div);
      popupEl = div;
      div.querySelector("#popOk").onclick = closePopup;
      div.querySelector("#popClose").onclick = closePopup;
    }

    function forceSetPdf(src){
      if(src === lastPdfSrc) return;
      lastPdfSrc = src;
      pdfFrame.src = "about:blank";
      setTimeout(()=>{ pdfFrame.src = src; }, 35);
    }

    function applyImgTransform(){
      const s = fitScale * userScale;
      imgCanvas.style.transform = `translate(-50%, -50%) translate(${tx}px, ${ty}px) scale(${s})`;
    }

    function computeFitScale(){
      const rect = imgStage.getBoundingClientRect();
      const iw = imgEl.naturalWidth || 1;
      const ih = imgEl.naturalHeight || 1;

      // Set canvas to the image's natural pixel size so callouts are consistent
      imgCanvas.style.width = iw + "px";
      imgCanvas.style.height = ih + "px";

      // Fit (contain) so every image starts the same standard view
      const sx = rect.width / iw;
      const sy = rect.height / ih;
      fitScale = Math.min(sx, sy);

      // Reset view
      userScale = 1;
      tx = 0;
      ty = 0;
      applyImgTransform();
    }

    function focusImageOnPercent(x, y, zoom){
      const rect = imgStage.getBoundingClientRect();
      const iw = imgEl.naturalWidth || 1;
      const ih = imgEl.naturalHeight || 1;

      const px = iw * (x/100);
      const py = ih * (y/100);

      userScale = zoom || 2.0;

      const s = fitScale * userScale;
      const targetX = px * s;
      const targetY = py * s;

      const centerX = rect.width / 2;
      const centerY = rect.height / 2;

      // Because our canvas origin is centered via translate(-50%,-50%),
      // we pan by shifting tx/ty so the focused point lands in the stage center.
      // In canvas coordinate space, (0,0) is top-left of the image.
      tx = centerX - (targetX);
      ty = centerY - (targetY);

      applyImgTransform();
    }

    function clearCallouts(){
      calloutLayerImg.innerHTML = "";
      calloutLayerPdf.innerHTML = "";
    }

    function renderCallouts(mode){
      clearCallouts();
      const perBill = (CALLOUTS[billKey] || {});
      const list = (perBill[pageIndex] || []);
      if(!list.length) return;

      if(mode === "snap"){
        list.forEach(c=>{
          const dot = document.createElement("div");
          dot.className = "dot";
          dot.style.left = `calc(${c.x}% - 11px)`;
          dot.style.top  = `calc(${c.y}% - 11px)`;
          dot.onclick = ()=>{
            focusImageOnPercent(c.x, c.y, c.z || 2.0);
            showPopup(c.t, c.d);
          };
          calloutLayerImg.appendChild(dot);
        });
      }

      if(mode === "pdf"){
        // PDF overlay only makes sense on page 1 (we enforce that)
        list.forEach(c=>{
          const dot = document.createElement("div");
          dot.className = "dot";
          dot.style.left = `calc(${c.x}% - 11px)`;
          dot.style.top  = `calc(${c.y}% - 11px)`;
          dot.onclick = ()=>{
            // best-effort zoom inside PDF viewer
            const z = Math.max(110, Math.min(220, Math.round((c.z || 1.6) * 100)));
            const pdfSrc = `${BILLS[billKey].pages[0].src}#page=1&zoom=${z}&t=${Date.now()}`;
            forceSetPdf(pdfSrc);
            showPopup(c.t, c.d);
          };
          calloutLayerPdf.appendChild(dot);
        });
      }
    }

    async function loadPage(){
      closePopup();
      clearCallouts();

      const bill = BILLS[billKey];
      const total = bill.pages.length;
      pageIndex = Math.max(1, Math.min(total, pageIndex));
      pagePill.textContent = `Page ${pageIndex} / ${total}`;

      const p = bill.pages[pageIndex-1];

      // reset view
      pdfFrame.style.display = "none";
      imgStage.style.display = "none";

      // reset snapshot state
      fitScale = 1; userScale = 1; tx = 0; ty = 0; applyImgTransform();

      if(p.type === "pdf"){
        const pdfSrc = `${p.src}#page=${p.pdfPage || 1}&zoom=page-width&t=${Date.now()}`;
        pdfFrame.style.display = "block";
        lastPdfSrc = "";
        forceSetPdf(pdfSrc);

        openBtn.onclick = ()=> window.open(pdfSrc, "_blank", "noopener");

        // callouts only if we have them for this page
        renderCallouts("pdf");
      }else{
        // snapshot resolve
        const resolved = await resolveFirstExisting(p.base);
        imgStage.style.display = "block";

        if(!resolved){
          imgEl.src = "";
          showPopup("Missing file", `Upload: ${p.base}.jpg (or .png/.pdf) to the same folder as index.html.`);
          openBtn.onclick = ()=>{};
          return;
        }

        imgEl.onload = ()=>{
          computeFitScale();
          renderCallouts("snap");
        };
        imgEl.src = resolved;
        openBtn.onclick = ()=> window.open(resolved, "_blank", "noopener");
      }
    }

    function resetFit(){
      closePopup();
      if(imgStage.style.display === "block" && imgEl.naturalWidth){
        computeFitScale();
      }else{
        // reload pdf at fit width
        const bill = BILLS[billKey];
        const p = bill.pages[pageIndex-1];
        if(p.type === "pdf"){
          lastPdfSrc = "";
          const pdfSrc = `${p.src}#page=${p.pdfPage || 1}&zoom=page-width&t=${Date.now()}`;
          forceSetPdf(pdfSrc);
        }
      }
    }

    /* =========================
       TAB NAV (single-page)
       ========================= */
    const tabLinks = Array.from(document.querySelectorAll("#tabs .tab"));
    const pages = {
      bill: document.getElementById("page-bill"),
      approach: document.getElementById("page-approach"),
      growth: document.getElementById("page-growth")
    };

    function setTab(which){
      tabLinks.forEach(a => a.classList.toggle("active", a.getAttribute("href") === `#${which}`));
      Object.keys(pages).forEach(k => pages[k].classList.toggle("active", k === which));
      // Keep bill viewer stable when switching back
      if(which === "bill") loadPage();
      window.scrollTo({ top: 0, behavior: "instant" });
    }

    window.addEventListener("hashchange", ()=>{
      const h = (location.hash || "#bill").replace("#","");
      if(pages[h]) setTab(h);
    });

    /* =========================
       UI EVENTS
       ========================= */
    billSelect.addEventListener("change", ()=>{
      billKey = billSelect.value;
      pageIndex = 1;
      lastPdfSrc = "";
      loadPage();
    });

    prevBtn.addEventListener("click", ()=>{
      pageIndex -= 1;
      loadPage();
    });

    nextBtn.addEventListener("click", ()=>{
      pageIndex += 1;
      loadPage();
    });

    fitBtn.addEventListener("click", resetFit);

    /* =========================
       INIT
       ========================= */
    (function init(){
      const h = (location.hash || "#bill").replace("#","");
      if(pages[h]) setTab(h);
      billSelect.value = "tou";
      billKey = "tou";
      pageIndex = 1;
      loadPage();
    })();
  </script>
</body>
</html>
